<%- include('./partials/header') %>
<%- include('./partials/flashMessage') %>

<div class="w-full h-fit flex flex-col justify-center items-start px-[5vw] md:px-[10vw] pb-20 gap-[10vw] lg:gap-20">
    <% if(cartItems && cartItems.length > 0) { %>
        <% cartItems.forEach((item)=> { %>
            <% if(item.productId) { %>
                <div class="w-full gap-0 md:gap-[5%] flex flex-col sm:flex-row items-center justify-center h-auto">
                    <div class="w-full md:w-[35%] lg:w-[30%] rounded-md overflow-hidden shadow-lg"
                        style="--bg-color: <%= item.productId.bgcolor %>; --text-color: <%= item.productId.textcolor %>; --panel-color: <%= item.productId.panelcolor %>; background-color: var(--bg-color);">
                        <div class="w-full h-68 md:h-80 flex items-center justify-center">
                            <img src="data:image/jpeg;base64,<%= item.productId.image.toString('base64') %>"
                                class="w-4/7 h-6/7 object-contain" alt="<%= item.productId.name %>">
                        </div>
                        <div class="w-full flex sm:flex-row justify-between px-4 md:px-5 py-4 gap-3 sm:gap-0"
                            style="color: var(--text-color); background-color: var(--panel-color);">
                            <h3 class="text-xl md:text-2xl font-medium">
                                <%= item.productId.name %>
                            </h3>
                        </div>
                        <div class="flex items-center justify-between px-4 md:px-5 py-3"
                            style="color: white; background-color: var(--text-color);">
                            <h4 class="text-base md:text-lg font-medium">Net Total</h4>
                            <h2 class="text-base md:text-lg font-semibold text-green-600">₹ <%=
                                    (item.productId.price + 20 - item.productId.discount) * item.quantity %>
                            </h2>
                        </div>
                    </div>
                    <div class="w-full md:w-[60%] h-full lg:w-[65%] mt-8 md:mt-0 flex flex-col rounded-lg shadow-lg">
                        <div class="flex w-full items-center justify-between mb-4 p-4 md:p-6 lg:p-8">
                            <h3 class="text-lg md:text-xl font-semibold">Price Breakdown</h3>
                            <div class="flex items-center gap-4">
                                <!-- Quantity Controls -->
                                <div class="flex items-center gap-2">
                                    <button onclick="updateQuantity('<%= item.productId._id %>', <%= item.quantity - 1 %>)" 
                                            class="bg-gray-200 hover:bg-gray-300 px-2 py-1 rounded">-</button>
                                    <span class="px-3 py-1 bg-gray-100 rounded"><%= item.quantity %></span>
                                    <button onclick="updateQuantity('<%= item.productId._id %>', <%= item.quantity + 1 %>)" 
                                            class="bg-gray-200 hover:bg-gray-300 px-2 py-1 rounded">+</button>
                                </div>
                                <a href="/removefromcart/<%= item.productId._id %>"
                                    class="text-red-500 hover:text-red-700 font-semibold transition-colors">
                                    <i class="ri-delete-bin-line text-xl"></i>
                                </a>
                            </div>
                        </div>
                        <div class="bg-white rounded-lg shadow-sm p-4 md:p-6 lg:p-8">
                            <div class="space-y-3 md:space-y-4">
                                <div class="flex justify-between items-center">
                                    <h4 class="text-sm md:text-base text-gray-700">Total MRP</h4>
                                    <h4 class="text-sm md:text-base font-medium">
                                        ₹<%= item.productId.price * item.quantity %>
                                    </h4>
                                </div>
                                <div class="flex justify-between items-center">
                                    <h4 class="text-sm md:text-base text-gray-700">Discount on MRP</h4>
                                    <h4 class="text-sm md:text-base font-medium">
                                        ₹<%= item.productId.discount * item.quantity %>
                                    </h4>
                                </div>
                                <div class="flex justify-between items-center">
                                    <h4 class="text-sm md:text-base text-gray-700">Platform Fee</h4>
                                    <h4 class="text-sm md:text-base font-medium">₹<%= 20 * item.quantity %></h4>
                                </div>
                                <div class="flex justify-between items-center">
                                    <h4 class="text-sm md:text-base text-gray-700">Shipping Fee</h4>
                                    <h4 class="text-sm md:text-base font-medium text-green-600">FREE</h4>
                                </div>
                            </div>
                            <div class="w-full h-[1px] bg-gray-300 my-4 md:my-6"></div>
                            <div class="flex justify-between items-center">
                                <h3 class="text-lg md:text-xl font-semibold">Total Amount</h3>
                                <h3 class="font-bold text-lg md:text-xl text-green-600">₹<%=
                                        (item.productId.price + 20 - item.productId.discount) * item.quantity %>
                                </h3>
                            </div>
                        </div>
                    </div>
                </div>
            <% } %>
        <% }) %>
        
        <!-- Cart Total -->
        <div class="w-full flex justify-end">
            <div class="bg-white rounded-lg shadow-lg p-6 w-full md:w-1/3">
                <h3 class="text-xl font-semibold mb-4">Cart Summary</h3>
                <div class="space-y-2">
                    <div class="flex justify-between">
                        <span>Subtotal:</span>
                        <span>₹<%= total %></span>
                    </div>
                    <div class="flex justify-between">
                        <span>Shipping:</span>
                        <span class="text-green-600">FREE</span>
                    </div>
                    <div class="border-t pt-2 mt-4">
                        <div class="flex justify-between font-semibold text-lg">
                            <span>Total:</span>
                            <span>₹<%= total %></span>
                        </div>
                    </div>
                </div>
                <button class="w-full bg-blue-500 hover:bg-blue-600 text-white font-semibold py-3 px-4 rounded-lg mt-4 transition-colors">
                    Proceed to Checkout
                </button>
            </div>
        </div>
    <% } else { %>
        <div class="w-full h-30 flex items-center justify-center">
            <div class="text-center">
                <h2 class="text-xl font-semibold text-yellow-500 mb-4">Your cart is empty.</h2>
                <a href="/shop" class="bg-blue-500 hover:bg-blue-600 text-white font-semibold py-2 px-4 rounded-lg transition-colors">
                    Continue Shopping
                </a>
            </div>
        </div>
    <% } %>
</div>

<script>
function updateQuantity(productId, quantity) {
    if (quantity <= 0) {
        // Remove item if quantity is 0 or negative
        window.location.href = `/removefromcart/${productId}`;
        return;
    }
    
    fetch(`/updatecart/${productId}`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({ quantity: quantity })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            window.location.reload();
        } else {
            alert('Failed to update cart');
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('Failed to update cart');
    });
}
</script>

<script src="/javascripts/flashMessage.js"></script>
<%- include('./partials/footer') %>