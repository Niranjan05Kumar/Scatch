<%- include('./partials/header') %>
    <!-- Deployment specific CSS -->
    <link rel="stylesheet" href="/stylesheets/deployment.css">
    
    <%- include('./partials/flashMessage') %>

        <div class="container mx-auto my-10 px-4">
            <div class="flex justify-center">
                <div class="w-full max-w-md lg:max-w-lg">
                    <div class="bg-gray-300 rounded-xl shadow-sm border border-gray-100">
                        <div class="p-6">
                            <div class="text-center mb-6">
                                <div
                                    class="mb-4 w-[120px] h-[120px] rounded-full overflow-hidden border-4 border-gray-200 mx-auto">
                                    <img id="profilePicture" 
                                         src="<%= user.picture %>" 
                                         alt="ProfilePicture"
                                         class="profile-picture h-full w-full object-cover" 
                                         onerror="handleImageError(this)">
                                </div>
                                <h4 class="text-2xl font-semibold mb-1">
                                    <%= user.fullname || 'User' %>
                                </h4>
                                <p class="text-gray-500">Member since <%= new
                                        Date(user.date || new Date()).toLocaleDateString('en-US', { year: 'numeric' , month: 'long' ,
                                        day: 'numeric' }) %>
                                </p>
                            </div>

                            <div class="space-y-4">
                                <div class="flex py-2 border-b border-gray-50">
                                    <div class="w-1/3">
                                        <strong class="font-medium">Name:</strong>
                                    </div>
                                    <div class="w-2/3">
                                        <%= user.fullname || 'User' %>
                                    </div>
                                </div>

                                <div class="flex py-2 border-b border-gray-50">
                                    <div class="w-1/3">
                                        <strong class="font-medium">Email:</strong>
                                    </div>
                                    <div class="w-2/3">
                                        <% if (user.email && user.email.indexOf('@') > 2) { %>
                                            <%= user.email.substring(0, 2) + '*'.repeat(user.email.indexOf('@') - 2) +
                                                user.email.substring(user.email.indexOf('@')) %>
                                        <% } else { %>
                                            <%= user.email || 'No email provided' %>
                                        <% } %>
                                    </div>
                                </div>

                                <div class="flex py-2">
                                    <div class="w-1/3">
                                        <strong class="font-medium">Contact:</strong>
                                    </div>
                                    <div class="w-2/3">
                                        <%= user.contact || 'Not provided' %>
                                    </div>
                                </div>
                            </div>

                            <div class="text-center mt-6 flex justify-start items-center gap-2">
                                <button>
                                    <a class="inline-block bg-blue-500 hover:bg-blue-400 text-white font-medium py-2 px-5 rounded-lg transition-colors duration-200"
                                        href="/users/edit">Edit Profile</a>
                                </button>
                                <button id="logoutBtn"
                                    class="cursor-pointer bg-red-500 hover:bg-red-400 text-white font-medium py-2 px-5 rounded-lg transition-colors duration-200">
                                    Logout
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Logout Confirmation Toast -->
        <div id="logoutToast" class="fixed inset-0 z-50 hidden items-center justify-center">
            <div
                class="bg-blue-400 rounded-lg shadow-xl p-6 mx-4 max-w-sm w-full transform transition-all duration-200">
                <div class="text-center">
                    <div class="mb-4">
                        <i class="ri-question-line text-4xl text-yellow-500"></i>
                    </div>
                    <h3 class="text-lg font-semibold text-gray-800 mb-2">Are you sure?</h3>
                    <p class="text-gray-600 mb-6">Do you really want to logout? You'll need to login again to access
                        your
                        account.</p>

                    <div class="flex gap-3 justify-center">
                        <button id="cancelLogout"
                            class="px-4 py-2 bg-gray-200 hover:bg-gray-300 text-gray-700 rounded-lg text-sm font-medium transition-colors duration-200">
                            Cancel
                        </button>
                        <a href="/users/logout"
                            class="px-4 py-2 bg-red-500 hover:bg-red-600 text-white rounded-lg text-sm font-medium transition-colors duration-200">
                            Confirm Logout
                        </a>
                    </div>
                </div>
            </div>
        </div>

        <script src="/javascripts/logoutConfirm.js"></script>
        <script src="/javascripts/flashMessage.js"></script>
        
        <!-- Fallback inline script for logout functionality -->
        <script>
          // Enhanced image error handling for Cloudinary
          function handleImageError(img) {
            console.log('Image failed to load:', img.src);
            
            // Cloudinary fallback URLs
            const fallbacks = [
              'https://res.cloudinary.com/demo/image/upload/c_fill,g_face,h_300,w_300/v1/samples/people/default-avatar.png',
              'https://via.placeholder.com/300x300/E5E7EB/9CA3AF?text=User',
              'data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMzAwIiBoZWlnaHQ9IjMwMCIgdmlld0JveD0iMCAwIDMwMCAzMDAiIGZpbGw9Im5vbmUiIHhtbG5zPSJodHRwOi8vd3d3LnczLm9yZy8yMDAwL3N2ZyI+CjxyZWN0IHdpZHRoPSIzMDAiIGhlaWdodD0iMzAwIiBmaWxsPSIjRTVFN0VCIi8+CjxjaXJjbGUgY3g9IjE1MCIgY3k9IjEyNSIgcj0iNTAiIGZpbGw9IiM5Q0EzQUYiLz4KPHBhdGggZD0iTTUwIDI0MEM1MCAyMDEuMzQgODEuMzQgMTcwIDEyMCAxNzBIMTgwQzIxOC42NiAxNzAgMjUwIDIwMS4zNCAyNTAgMjQwVjMwMEg1MFYyNDBaIiBmaWxsPSIjOUNBM0FGIi8+Cjwvc3ZnPgo='
            ];
            
            const currentSrc = img.src;
            let nextFallback = null;
            
            for (let i = 0; i < fallbacks.length; i++) {
              if (currentSrc !== fallbacks[i]) {
                nextFallback = fallbacks[i];
                break;
              }
            }
            
            if (nextFallback) {
              console.log('Trying Cloudinary fallback:', nextFallback);
              img.src = nextFallback;
            }
          }
          
          // Backup logout functionality in case external script fails
          document.addEventListener('DOMContentLoaded', function() {
            const logoutBtn = document.getElementById("logoutBtn");
            const logoutToast = document.getElementById("logoutToast");
            const cancelLogout = document.getElementById("cancelLogout");
            
            if (logoutBtn && logoutToast && cancelLogout) {
              logoutBtn.addEventListener("click", function(e) {
                e.preventDefault();
                logoutToast.classList.remove("hidden");
                logoutToast.classList.add("flex");
              });
              
              cancelLogout.addEventListener("click", function(e) {
                e.preventDefault();
                logoutToast.classList.add("hidden");
                logoutToast.classList.remove("flex");
              });
            }
            
            // Check if profile picture loads
            const profileImg = document.getElementById('profilePicture');
            if (profileImg) {
              profileImg.addEventListener('load', function() {
                console.log('Profile picture loaded successfully');
              });
            }
          });
        </script>

        <%- include('./partials/footer') %>